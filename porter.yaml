# This is the configuration for Porter
# You must define steps for each action, but the rest is optional
# See https://porter.sh/author-bundles for documentation on how to configure your bundle
# Uncomment out the sections below to take full advantage of what Porter can do!

name: cncf-projects-app
version: 0.1.0
description: "A bundle that installs and removes the CNCF demo project. Use \"porter explain --tag <registry>/<organization>/<repository>/<image name>:version\" to display required and optional parameters, credentials, and outputs."
tag: ghcr.io/squillace/cncf-projects-app/cncf:v0.1.0

# Moves mixins up to the top for faster bundle dev iteration
dockerfile: Dockerfile.tmpl

mixins:
  - exec
  - kubernetes
  - helm3:
      clientVersion: v3.3.2


install:
  - exec:
      command: bash
      description: "Creating the ingress namespace."
      flags:
          c: '"kubectl create namespace ingress-basic"'   
  - helm3:
      description: "Adding the \'stable\' Helm chart repository."  
      repositories:
        stable:
          url: "https://kubernetes-charts.storage.googleapis.com"
  - helm3:
      description: "Use Helm to deploy an NGINX ingress controller."
      name: nginx-ingress
      chart: stable/nginx-ingress
  #      version: CHART_VERSION
      namespace: "{{bundle.parameters.ingress-namespace}}"
      replace: true
      wait: true # default true
      set:
        controller.replicaCount: 2
        controller.nodeSelector.beta.kubernetes.io/os: linux      
        defaultBackend.nodeSelector.beta.kubernetes.io/os: linux
 



upgrade:
  - exec:
      description: "TODO: understand what upgrade of this might mean."
      command: ./helpers.sh
      arguments:
        - upgrade

uninstall:
  - exec:
      description: "Uninstall Hello World"
      command: ./helpers.sh
      arguments:
        - uninstall

# Below is an example of how to define credentials
# See https://porter.sh/author-bundles/#credentials
credentials:
  - name: kubeconfig
    type: file
    path: /root/.kube/config
#  - name: username
#    env: USERNAME

# Below is an example of how to define parameters
# See https://porter.sh/author-bundles/#parameters
parameters:
  - name: ingress-namespace
    type: string
    default: ingress-basic
